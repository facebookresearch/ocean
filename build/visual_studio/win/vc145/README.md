# Ocean Visual Studio Build System

This document describes the Visual Studio project structure and property sheet (`.props`) patterns used to build the Ocean library on Windows and Android.

## Overview

The Ocean Visual Studio build system uses a modular property sheet architecture that simplifies project configuration, dependency management, and build settings. Each Ocean library follows a consistent pattern with multiple `.props` files serving different purposes.

## Supported Platforms

The Visual Studio build system supports multiple target platforms:

| Directory | Platform | Description |
|-----------|----------|-------------|
| `win\vc145` | Windows | Windows desktop builds |
| `android\vc145` | Android | Android builds via Visual Studio |

## Directory Structure

```
build/visual_studio/
├── generate_reference_props.ps1   # Script to generate *_reference.props files (all platforms)
├── win/
│   └── vc145/
│       ├── ocean_common.props
│       ├── win_vc145.sln
│       ├── README.md
│       └── ocean/
│           ├── ocean_library_build.props
│           ├── base/
│           │   ├── base.vcxproj
│           │   ├── base_common.props
│           │   ├── base_build.props
│           │   ├── base_use.props
│           │   └── base_reference.props   # (auto-generated)
│           └── ...
└── android/
    └── vc145/
        ├── ocean_common.props
        ├── android_vc145.sln
        └── ocean/
            └── ...
```

## Property Sheet Patterns

Each Ocean library uses a set of `.props` files that follow a specific naming convention and serve distinct purposes:

### `*_common.props` - Common Settings

**Purpose**: Defines settings shared between building the library and consuming it.

**Contains**:
- An import guard property (e.g., `ocean_cv_common_imported`)
- Imports of `ocean_common.props` for root settings
- Imports of `*_use.props` files from dependency libraries

**Example** (`cv_common.props`):
```xml
<ImportGroup Label="Dependencies">
  <Import Condition="'$(ocean_common_imported)' != 'True'" Project="..\..\ocean_common.props"/>
  <Import Condition="'$(ocean_base_use_imported)' != 'True'" Project="..\base\base_use.props"/>
  <Import Condition="'$(ocean_math_use_imported)' != 'True'" Project="..\math\math_use.props"/>
</ImportGroup>
```

### `*_build.props` - Build Settings

**Purpose**: Defines settings used only when building the library itself.

**Contains**:
- An import guard property (e.g., `ocean_cv_build_imported`)
- Import of `*_common.props` for shared settings
- Import of `*_reference.props` for project dependencies
- Import of `ocean_library_build.props` for shared library build settings
- Target name configuration (debug/release variants)
- DLL export preprocessor definitions (for shared builds)

**Example** (`cv_build.props`):
```xml
<ImportGroup Label="Dependencies">
  <Import Condition="'$(ocean_cv_common_imported)' != 'True'" Project="cv_common.props"/>
  <Import Condition="'$(ocean_cv_reference_imported)' != 'True'" Project="cv_reference.props"/>
  <Import Condition="'$(ocean_library_build_imported)' != 'True'" Project="..\ocean_library_build.props"/>
</ImportGroup>
```

### `*_use.props` - Consumer Settings

**Purpose**: Defines settings for projects that consume/link against the library.

**Contains**:
- An import guard property (e.g., `ocean_cv_use_imported`)
- Import of `*_common.props` for shared settings
- Linker settings specifying the library file to link (e.g., `OceanCV.lib` or `OceanCVD.lib`)

**Example** (`cv_use.props`):
```xml
<ItemDefinitionGroup Condition="'$(Configuration)'=='Static Debug' Or '$(Configuration)'=='Shared Debug'">
  <Link>
    <AdditionalDependencies>OceanCVD.lib;%(AdditionalDependencies)</AdditionalDependencies>
  </Link>
</ItemDefinitionGroup>
```

### `*_reference.props` - Project References (Auto-Generated)

**Purpose**: Defines `<ProjectReference>` elements that establish build order dependencies between projects.

**Contains**:
- An import guard property (e.g., `ocean_cv_reference_imported`)
- `<ProjectReference>` elements for each dependency project
- `<LinkLibraryDependencies>false</LinkLibraryDependencies>` to prevent automatic linking (handled by `*_use.props`)

**Example** (`cv_reference.props`):
```xml
<!--
  This file was auto-generated by generate_reference_props.ps1
  Do not edit manually. Re-run the script to regenerate.
-->
<ItemGroup>
  <ProjectReference Include="..\base\base.vcxproj">
    <Project>{7EF9186B-5F2C-47B0-8077-5D60AF030B68}</Project>
    <LinkLibraryDependencies>false</LinkLibraryDependencies>
  </ProjectReference>
  <ProjectReference Include="..\math\math.vcxproj">
    <Project>{FEA50A96-F160-4C9D-8313-7479649D0B2D}</Project>
    <LinkLibraryDependencies>false</LinkLibraryDependencies>
  </ProjectReference>
</ItemGroup>
```

**Key Benefits**:
- Dependencies are stored in the `.vcxproj` (via the imported `.props`), not just in the `.sln` file
- Projects are portable - adding them to any solution automatically includes their dependencies
- Build order is determined by MSBuild automatically

## Import Hierarchy

The following diagram shows how the property sheets are imported:

```
When BUILDING a library (e.g., cv.vcxproj imports cv_build.props):

cv_build.props
├── cv_common.props
│   ├── ocean_common.props
│   ├── base_use.props
│   │   └── base_common.props
│   │       └── ocean_common.props
│   └── math_use.props
│       └── math_common.props
│           ├── ocean_common.props
│           └── base_use.props
├── cv_reference.props
│   └── (ProjectReference elements)
└── ocean_library_build.props
    └── ocean_common.props


When USING a library (e.g., a consumer imports cv_use.props):

cv_use.props
└── cv_common.props
    ├── ocean_common.props
    ├── base_use.props
    └── math_use.props
```

## Generating Reference Props Files

The `*_reference.props` files are auto-generated from the `*_common.props` files using a PowerShell script located at `build/visual_studio/generate_reference_props.ps1`.

### Usage

```powershell
# Navigate to the visual_studio directory
cd build/visual_studio

# Generate *_reference.props files for ALL platforms (default behavior)
.\generate_reference_props.ps1

# Generate AND update *_build.props files to import them
.\generate_reference_props.ps1 -UpdateBuildProps

# Process only a specific directory
.\generate_reference_props.ps1 -RootPath ".\win\vc145"
.\generate_reference_props.ps1 -RootPath ".\android\vc145"
```

### Script Parameters

| Parameter | Description |
|-----------|-------------|
| (none) | Process all platform directories (win, android) |
| `-RootPath <path>` | Process only the specified directory |
| `-UpdateBuildProps` | Also update `*_build.props` files to import the generated reference files |

### How It Works

1. Scans all `*_common.props` files in the directory tree
2. Parses each file to extract `*_use.props` imports (these define the dependencies)
3. Locates the corresponding `.vcxproj` files and extracts their project GUIDs
4. Generates `*_reference.props` files with `<ProjectReference>` elements
5. Optionally updates `*_build.props` files to import the generated reference files

### When to Run

Run this script when:
- Adding a new library to the Ocean project
- Changing dependencies in a `*_common.props` file
- Setting up a fresh checkout and need to generate the reference files

## Import Guards

Each `.props` file defines an import guard property to prevent multiple imports:

```xml
<PropertyGroup>
  <ocean_cv_common_imported>True</ocean_cv_common_imported>
</PropertyGroup>
```

And checks this property before importing:

```xml
<Import Condition="'$(ocean_cv_common_imported)' != 'True'" Project="cv_common.props"/>
```

This pattern ensures that:
- Each property sheet is only imported once
- Circular dependencies don't cause infinite loops
- Import order is flexible without duplicating settings

## Adding a New Library

To add a new Ocean library (e.g., `newlib`):

1. **Create the `.vcxproj` file** with a unique `<ProjectGuid>`

2. **Create `newlib_common.props`**:
   ```xml
   <?xml version="1.0" encoding="utf-8"?>
   <Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
     <PropertyGroup>
       <_PropertySheetDisplayName>Ocean NewLib (Common)</_PropertySheetDisplayName>
     </PropertyGroup>
     <PropertyGroup>
       <ocean_newlib_common_imported>True</ocean_newlib_common_imported>
     </PropertyGroup>
     <ImportGroup Label="Dependencies">
       <Import Condition="'$(ocean_common_imported)' != 'True'" Project="..\..\ocean_common.props"/>
       <Import Condition="'$(ocean_base_use_imported)' != 'True'" Project="..\base\base_use.props"/>
       <!-- Add other dependencies here -->
     </ImportGroup>
   </Project>
   ```

3. **Create `newlib_build.props`** and **`newlib_use.props`** following the patterns above

4. **Run the generator script** to create `newlib_reference.props`:
   ```powershell
   .\generate_reference_props.ps1 -UpdateBuildProps
   ```

5. **Add the project to `win_vc145.sln`**

The project references will be automatically established via the imported `*_reference.props` file.
