<?xml version="1.0" encoding="utf-8"?>
<!--
  Ocean Android Extension - Java Library Project
  Uses Makefile project type with Gradle build integration.
  Produces an AAR (Android Archive) library that can be referenced by other libraries or applications.
-->
<Project DefaultTargets="Build" ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Project configurations - Debug/Release -->
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM">
      <Configuration>Debug</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM">
      <Configuration>Release</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x86">
      <Configuration>Debug</Configuration>
      <Platform>x86</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x86">
      <Configuration>Release</Configuration>
      <Platform>x86</Platform>
    </ProjectConfiguration>
  </ItemGroup>

  <!-- Global project properties -->
  <PropertyGroup Label="Globals">
    <ProjectGuid>{$guid1$}</ProjectGuid>
    <RootNamespace>$safeprojectname$</RootNamespace>
    <ProjectName>$safeprojectname$</ProjectName>
    <Keyword>AndroidJavaLibrary</Keyword>

    <!-- Use Makefile project type - build is handled by Gradle -->
    <ConfigurationType>Makefile</ConfigurationType>

    <!-- Mark this as an Android Java Library -->
    <IsAndroidJavaLibrary>true</IsAndroidJavaLibrary>

    <!-- Gradle module name -->
    <GradleModuleName>lib</GradleModuleName>

    <!-- Android settings (editable in Project Properties) -->
    <AndroidNamespace>com.example.$safeprojectname$</AndroidNamespace>
    <AndroidMinSdk>24</AndroidMinSdk>
    <AndroidCompileSdk>34</AndroidCompileSdk>
    <JavaVersion>VERSION_17</JavaVersion>
  </PropertyGroup>

  <!-- Import VCTargets Default Props -->
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />

  <!-- Configuration type for all configurations -->
  <PropertyGroup Label="Configuration">
    <ConfigurationType>Makefile</ConfigurationType>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>

  <!-- Default output directories - defined BEFORE Microsoft.Cpp.props so they act as defaults -->
  <!-- User .props files imported via PropertySheets can override these unconditionally -->
  <PropertyGroup>
    <IntDir Condition="'$(IntDir)' == ''">$(MSBuildProjectDirectory)\obj\$(Platform)\$(Configuration)\</IntDir>
    <OutDir Condition="'$(OutDir)' == ''">$(MSBuildProjectDirectory)\bin\$(Platform)\$(Configuration)\</OutDir>
  </PropertyGroup>

  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />

  <ImportGroup Label="ExtensionSettings" />
  <ImportGroup Label="Shared" />
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props"
            Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')"
            Label="LocalAppDataPlatform" />
  </ImportGroup>

  <PropertyGroup Label="UserMacros" />

  <!-- Project Capabilities for VS extension integration -->
  <ItemGroup>
    <ProjectCapability Include="AndroidJavaLibrary" />
  </ItemGroup>

  <!-- Path Configuration -->
  <PropertyGroup>
    <!-- Java source staging directory -->
    <JavaStagingDir>$(IntDir)java-staging</JavaStagingDir>

    <!-- Gradle directories -->
    <GradleProjectDir>$(MSBuildProjectDirectory)\gradle</GradleProjectDir>
    <GradleWrapper>$(GradleProjectDir)\gradlew.bat</GradleWrapper>
    <GradleModuleDir>$(MSBuildProjectDirectory)\lib</GradleModuleDir>

    <!-- AAR output path (Gradle's output location - in intermediate dir) -->
    <GradleBuildDir>$(IntDir)gradle-build</GradleBuildDir>
    <AarOutputDir>$(GradleBuildDir)\outputs\aar</AarOutputDir>
    <AarOutputFile Condition="'$(Configuration)' == 'Debug'">$(AarOutputDir)\lib-debug.aar</AarOutputFile>
    <AarOutputFile Condition="'$(Configuration)' == 'Release'">$(AarOutputDir)\lib-release.aar</AarOutputFile>

    <!-- Final output location (copied after Gradle build) -->
    <FinalAarPath>$(OutDir)$(ProjectName).aar</FinalAarPath>
  </PropertyGroup>

  <!-- Android SDK and Java Home resolution (shared props from extension) -->
  <PropertyGroup>
    <_OceanExtensionPath Condition="'$(_OceanExtensionPath)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_CURRENT_USER\Software\OceanAndroidExtension', 'ExtensionPath', '', RegistryView.Default))</_OceanExtensionPath>
    <_OceanCommonPropsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\OceanAndroidCommon\OceanAndroidCommon.props')">$(_OceanExtensionPath)\toolset\OceanAndroidCommon\OceanAndroidCommon.props</_OceanCommonPropsPath>
    <!-- Development fallback: relative to template location -->
    <_OceanCommonPropsPath Condition="'$(_OceanCommonPropsPath)' == '' AND Exists('$(MSBuildThisFileDirectory)..\..\toolset\OceanAndroidCommon\OceanAndroidCommon.props')">$(MSBuildThisFileDirectory)..\..\toolset\OceanAndroidCommon\OceanAndroidCommon.props</_OceanCommonPropsPath>
  </PropertyGroup>
  <Import Project="$(_OceanCommonPropsPath)" Condition="'$(_OceanCommonPropsPath)' != '' AND Exists('$(_OceanCommonPropsPath)')" />

  <PropertyGroup>
    <!-- Gradle task based on configuration -->
    <GradleTask Condition="'$(Configuration)' == 'Release'">:lib:assembleRelease</GradleTask>
    <GradleTask Condition="'$(GradleTask)' == ''">:lib:assembleDebug</GradleTask>

    <!-- Gradle cache directory (redirected out of source tree) -->
    <GradleCacheDir>$(IntDir)gradle-cache</GradleCacheDir>
    <!-- Gradle properties to pass (from VS project settings) -->
    <GradleProperties>--project-cache-dir="$(GradleCacheDir)" -PprojectName="$(ProjectName)" -PjavaStagingDir="$(JavaStagingDir)" -PandroidNamespace="$(AndroidNamespace)" -PandroidMinSdk=$(AndroidMinSdk) -PandroidCompileSdk=$(AndroidCompileSdk) -PjavaVersion=$(JavaVersion) -PgradleBuildDir="$(GradleBuildDir)"</GradleProperties>
  </PropertyGroup>

  <!-- Makefile project commands -->
  <PropertyGroup>
    <NMakeBuildCommandLine>cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" $(GradleTask) $(GradleProperties) --no-daemon</NMakeBuildCommandLine>
    <NMakeReBuildCommandLine>cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" clean $(GradleTask) $(GradleProperties) --no-daemon</NMakeReBuildCommandLine>
    <NMakeCleanCommandLine>cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" clean $(GradleProperties) --no-daemon</NMakeCleanCommandLine>
    <NMakeOutput>$(FinalAarPath)</NMakeOutput>
  </PropertyGroup>

  <!-- Java source files -->
  <ItemGroup>
    <JavaSource Include="lib\src\*.java" />
  </ItemGroup>

  <!-- Project Items for Solution Explorer -->
  <ItemGroup>
    <!-- Gradle build files -->
    <None Include="lib\build.gradle.kts" />
    <None Include="gradle\build.gradle.kts" />
    <None Include="gradle\settings.gradle.kts" />
    <None Include="gradle\gradle.properties" />
  </ItemGroup>

  <ItemGroup>
    <!-- Java sources displayed in Solution Explorer -->
    <None Include="lib\src\$safeprojectname$.java" />
  </ItemGroup>

  <!-- GetGradleModulePath - returns the path to this library's Gradle module -->
  <Target Name="GetGradleModulePath" Returns="$(GradleModuleDir)">
    <Message Text="[$(ProjectName)] Gradle module path: $(GradleModuleDir)" Importance="low" />
  </Target>

  <!-- GetJavaStagingPath - returns the path to staged Java sources -->
  <Target Name="GetJavaStagingPath" DependsOnTargets="StageJavaSources" Returns="$(JavaStagingDir)">
    <Message Text="[$(ProjectName)] Java staging path: $(JavaStagingDir)" Importance="low" />
  </Target>

  <!-- GetAarOutputPath - returns the path to the built AAR -->
  <Target Name="GetAarOutputPath" Returns="$(FinalAarPath)">
    <Message Text="[$(ProjectName)] AAR output path: $(FinalAarPath)" Importance="low" />
  </Target>

  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />

  <ImportGroup Label="ExtensionTargets" />

  <!-- ============================================================
       Property Page Registration
       ============================================================ -->
  <PropertyGroup>
    <_OceanExtensionPath Condition="'$(_OceanExtensionPath)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_CURRENT_USER\Software\OceanAndroidExtension', 'ExtensionPath', '', RegistryView.Default))</_OceanExtensionPath>
    <_OceanJavaLibPropsPath Condition="'$(_OceanExtensionPath)' != ''">$(_OceanExtensionPath)\toolset\OceanJavaLib\OceanJavaLib.General.xml</_OceanJavaLibPropsPath>
    <_OceanJavaLibPropsPath Condition="'$(_OceanJavaLibPropsPath)' == '' OR !Exists('$(_OceanJavaLibPropsPath)')">$(MSBuildThisFileDirectory)..\..\toolset\OceanJavaLib\OceanJavaLib.General.xml</_OceanJavaLibPropsPath>
  </PropertyGroup>

  <ItemGroup Condition="Exists('$(_OceanJavaLibPropsPath)')">
    <PropertyPageSchema Include="$(_OceanJavaLibPropsPath)" />
  </ItemGroup>

  <!-- ============================================================
       Java Source Staging (shared targets)

       Import the shared StageJavaFile task, StageJavaSources target,
       and CleanStagedJavaSources target from the extension toolset.
       ============================================================ -->
  <PropertyGroup>
    <_JavaStagingTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\JavaStaging\JavaStaging.targets')"
      >$(_OceanExtensionPath)\toolset\JavaStaging\JavaStaging.targets</_JavaStagingTargetsPath>
    <!-- Development fallback: relative to template location (templates/AndroidLibrary/) -->
    <_JavaStagingTargetsPath Condition="'$(_JavaStagingTargetsPath)' == '' AND Exists('$(MSBuildThisFileDirectory)..\..\toolset\JavaStaging\JavaStaging.targets')"
      >$(MSBuildThisFileDirectory)..\..\toolset\JavaStaging\JavaStaging.targets</_JavaStagingTargetsPath>
  </PropertyGroup>
  <Import Project="$(_JavaStagingTargetsPath)"
          Condition="'$(_JavaStagingTargetsPath)' != '' AND Exists('$(_JavaStagingTargetsPath)')" />

  <!-- ============================================================
       Gradle Wrapper Verification (shared targets)

       Import the shared VerifyFileHash task and VerifyGradleWrapper target
       from the extension toolset.
       ============================================================ -->
  <PropertyGroup>
    <_GradleWrapperTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\GradleWrapper\GradleWrapper.targets')"
      >$(_OceanExtensionPath)\toolset\GradleWrapper\GradleWrapper.targets</_GradleWrapperTargetsPath>
    <!-- Development fallback: relative to template location (templates/AndroidLibrary/) -->
    <_GradleWrapperTargetsPath Condition="'$(_GradleWrapperTargetsPath)' == '' AND Exists('$(MSBuildThisFileDirectory)..\..\toolset\GradleWrapper\GradleWrapper.targets')"
      >$(MSBuildThisFileDirectory)..\..\toolset\GradleWrapper\GradleWrapper.targets</_GradleWrapperTargetsPath>
  </PropertyGroup>
  <Import Project="$(_GradleWrapperTargetsPath)"
          Condition="'$(_GradleWrapperTargetsPath)' != '' AND Exists('$(_GradleWrapperTargetsPath)')" />

  <!-- ============================================================
       Java Validation (shared targets)

       Import the shared DetectJavaVersion task and _ValidateJavaHome target
       from the extension toolset.
       ============================================================ -->
  <PropertyGroup>
    <_JavaValidationTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\JavaValidation\JavaValidation.targets')"
      >$(_OceanExtensionPath)\toolset\JavaValidation\JavaValidation.targets</_JavaValidationTargetsPath>
    <!-- Development fallback: relative to template location (templates/AndroidLibrary/) -->
    <_JavaValidationTargetsPath Condition="'$(_JavaValidationTargetsPath)' == '' AND Exists('$(MSBuildThisFileDirectory)..\..\toolset\JavaValidation\JavaValidation.targets')"
      >$(MSBuildThisFileDirectory)..\..\toolset\JavaValidation\JavaValidation.targets</_JavaValidationTargetsPath>
  </PropertyGroup>
  <Import Project="$(_JavaValidationTargetsPath)"
          Condition="'$(_JavaValidationTargetsPath)' != '' AND Exists('$(_JavaValidationTargetsPath)')" />

  <!-- ============================================================
       Custom Build Targets
       ============================================================ -->

  <!-- Build Target - stages Java sources, runs Gradle, copies AAR -->
  <Target Name="Build" DependsOnTargets="VerifyGradleWrapper">
    <!-- Display Java source files being compiled -->
    <Message Text="%(JavaSource.Filename)%(JavaSource.Extension)" Importance="high" />

    <!-- Run Gradle build -->
    <Message Text="Building AAR with Gradle..." Importance="high" />
    <Exec Command="&quot;$(GradleWrapper)&quot; $(GradleTask) $(GradleProperties) --no-daemon"
          WorkingDirectory="$(GradleProjectDir)"
          EnvironmentVariables="ANDROID_HOME=$(AndroidSdkPath);JAVA_HOME=$(JavaHome)"
          ConsoleToMsBuild="true"
          Condition="Exists('$(GradleWrapper)')" />

    <Warning Text="Gradle wrapper not found at $(GradleWrapper). Please ensure gradlew.bat exists."
             Condition="!Exists('$(GradleWrapper)')" />

    <!-- Copy AAR to output directory -->
    <MakeDir Directories="$(OutDir)" Condition="!Exists('$(OutDir)')" />
    <Copy SourceFiles="$(AarOutputFile)"
          DestinationFiles="$(FinalAarPath)"
          SkipUnchangedFiles="true"
          Condition="Exists('$(AarOutputFile)')" />

    <!-- Display output path similar to native library -->
    <Message Text="$(MSBuildProjectFile) -> $([System.IO.Path]::GetFullPath('$(FinalAarPath)'))" Importance="high" />
  </Target>

  <!-- Clean Target -->
  <Target Name="Clean" DependsOnTargets="CleanStagedJavaSources">
    <Message Text="Cleaning with Gradle..." Importance="high" />
    <Exec Command="&quot;$(GradleWrapper)&quot; clean $(GradleProperties) --no-daemon"
          WorkingDirectory="$(GradleProjectDir)"
          EnvironmentVariables="ANDROID_HOME=$(AndroidSdkPath);JAVA_HOME=$(JavaHome)"
          ConsoleToMsBuild="true"
          IgnoreExitCode="true"
          Condition="Exists('$(GradleWrapper)')" />

    <!-- Remove output AAR -->
    <Delete Files="$(FinalAarPath)" Condition="Exists('$(FinalAarPath)')" />
    <Message Text="[$(ProjectName)] Cleaned" Importance="normal" />
  </Target>

  <!-- Rebuild Target -->
  <Target Name="Rebuild" DependsOnTargets="Clean;Build" />

</Project>
