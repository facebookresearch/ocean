<?xml version="1.0" encoding="utf-8"?>
<!--
  Ocean Android Extension - Common Targets
  Shared target imports for Android Application and Java Library projects.
  Resolves the extension path from registry and imports shared targets:
    - JavaStaging.targets (package-aware Java source staging)
    - GradleWrapper.targets (SHA-256 wrapper JAR verification)
    - JavaValidation.targets (Java Home validation and version detection)
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Resolve extension path from registry (set by extension at startup) -->
  <PropertyGroup>
    <_OceanExtensionPath Condition="'$(_OceanExtensionPath)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_CURRENT_USER\Software\OceanAndroidExtension', 'ExtensionPath', '', RegistryView.Default))</_OceanExtensionPath>
  </PropertyGroup>

  <!-- Java Source Staging -->
  <PropertyGroup>
    <_JavaStagingTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\JavaStaging\JavaStaging.targets')"
      >$(_OceanExtensionPath)\toolset\JavaStaging\JavaStaging.targets</_JavaStagingTargetsPath>
  </PropertyGroup>
  <Import Project="$(_JavaStagingTargetsPath)"
          Condition="'$(_JavaStagingTargetsPath)' != '' AND Exists('$(_JavaStagingTargetsPath)')" />

  <!-- Gradle Wrapper Verification -->
  <PropertyGroup>
    <_GradleWrapperTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\GradleWrapper\GradleWrapper.targets')"
      >$(_OceanExtensionPath)\toolset\GradleWrapper\GradleWrapper.targets</_GradleWrapperTargetsPath>
  </PropertyGroup>
  <Import Project="$(_GradleWrapperTargetsPath)"
          Condition="'$(_GradleWrapperTargetsPath)' != '' AND Exists('$(_GradleWrapperTargetsPath)')" />

  <!-- Java Validation -->
  <PropertyGroup>
    <_JavaValidationTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\JavaValidation\JavaValidation.targets')"
      >$(_OceanExtensionPath)\toolset\JavaValidation\JavaValidation.targets</_JavaValidationTargetsPath>
  </PropertyGroup>
  <Import Project="$(_JavaValidationTargetsPath)"
          Condition="'$(_JavaValidationTargetsPath)' != '' AND Exists('$(_JavaValidationTargetsPath)')" />

  <!-- Compose GradleProperties from base + project-specific properties.
       Projects set $(ProjectGradleProperties) for type-specific -P flags.
       This runs late (after project properties are evaluated) so all values are available. -->
  <PropertyGroup Condition="'$(ConfigurationType)' == 'Makefile'">
    <GradleProperties Condition="'$(GradleProperties)' == ''">$(GradleBaseProperties) $(ProjectGradleProperties)</GradleProperties>
  </PropertyGroup>

  <!-- NMake / Gradle Build Commands (shared pattern for Makefile-based Android projects).
       GradleTask and GradleProperties must be set by the project before this point.
       NMakeOutput remains project-specific (APK vs AAR). -->
  <PropertyGroup Condition="'$(ConfigurationType)' == 'Makefile'">
    <NMakeBuildCommandLine Condition="'$(NMakeBuildCommandLine)' == ''">cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" $(GradleTask) $(GradleProperties) --no-daemon</NMakeBuildCommandLine>
    <NMakeReBuildCommandLine Condition="'$(NMakeReBuildCommandLine)' == ''">cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" clean $(GradleTask) $(GradleProperties) --no-daemon</NMakeReBuildCommandLine>
    <NMakeCleanCommandLine Condition="'$(NMakeCleanCommandLine)' == ''">cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" clean $(GradleProperties) --no-daemon</NMakeCleanCommandLine>
  </PropertyGroup>

</Project>
