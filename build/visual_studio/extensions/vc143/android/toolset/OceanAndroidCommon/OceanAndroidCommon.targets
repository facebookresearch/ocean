<?xml version="1.0" encoding="utf-8"?>
<!--
  Ocean Android Extension - Common Targets
  Shared target imports for Android Application and Java Library projects.
  Resolves the extension path from registry and imports shared targets:
    - JavaStaging.targets (package-aware Java source staging)
    - GradleWrapper.targets (SHA-256 wrapper JAR verification)
    - JavaValidation.targets (Java Home validation and version detection)
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Resolve extension path from registry (set by extension at startup) -->
  <PropertyGroup>
    <_OceanExtensionPath Condition="'$(_OceanExtensionPath)' == ''">$([MSBuild]::GetRegistryValueFromView('HKEY_CURRENT_USER\Software\OceanAndroidExtension', 'ExtensionPath', '', RegistryView.Default))</_OceanExtensionPath>
  </PropertyGroup>

  <!-- Java Source Staging -->
  <PropertyGroup>
    <_JavaStagingTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\JavaStaging\JavaStaging.targets')"
      >$(_OceanExtensionPath)\toolset\JavaStaging\JavaStaging.targets</_JavaStagingTargetsPath>
  </PropertyGroup>
  <Import Project="$(_JavaStagingTargetsPath)"
          Condition="'$(_JavaStagingTargetsPath)' != '' AND Exists('$(_JavaStagingTargetsPath)')" />

  <!-- Gradle Wrapper Verification -->
  <PropertyGroup>
    <_GradleWrapperTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\GradleWrapper\GradleWrapper.targets')"
      >$(_OceanExtensionPath)\toolset\GradleWrapper\GradleWrapper.targets</_GradleWrapperTargetsPath>
  </PropertyGroup>
  <Import Project="$(_GradleWrapperTargetsPath)"
          Condition="'$(_GradleWrapperTargetsPath)' != '' AND Exists('$(_GradleWrapperTargetsPath)')" />

  <!-- Java Validation -->
  <PropertyGroup>
    <_JavaValidationTargetsPath Condition="'$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\JavaValidation\JavaValidation.targets')"
      >$(_OceanExtensionPath)\toolset\JavaValidation\JavaValidation.targets</_JavaValidationTargetsPath>
  </PropertyGroup>
  <Import Project="$(_JavaValidationTargetsPath)"
          Condition="'$(_JavaValidationTargetsPath)' != '' AND Exists('$(_JavaValidationTargetsPath)')" />

  <!-- Auto-import type-specific targets based on project markers.
       App projects set OutputType=AndroidApplication in Globals.
       Lib projects set IsAndroidJavaLibrary=true in Globals. -->
  <Import Project="$(_OceanExtensionPath)\toolset\OceanAndroidApp\OceanAndroidApp.targets"
          Condition="'$(OutputType)' == 'AndroidApplication' AND '$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\OceanAndroidApp\OceanAndroidApp.targets')" />

  <Import Project="$(_OceanExtensionPath)\toolset\OceanJavaLib\OceanJavaLib.targets"
          Condition="'$(IsAndroidJavaLibrary)' == 'true' AND '$(_OceanExtensionPath)' != '' AND Exists('$(_OceanExtensionPath)\toolset\OceanJavaLib\OceanJavaLib.targets')" />

  <!-- Compose GradleProperties from base + project-specific properties.
       Projects set $(ProjectGradleProperties) for type-specific -P flags.
       This runs late (after project properties are evaluated) so all values are available. -->
  <PropertyGroup Condition="'$(ConfigurationType)' == 'Makefile'">
    <GradleProperties Condition="'$(GradleProperties)' == ''">$(GradleBaseProperties) $(ProjectGradleProperties)</GradleProperties>
  </PropertyGroup>

  <!-- NMake / Gradle Build Commands (shared pattern for Makefile-based Android projects).
       GradleTask and GradleProperties must be set by the project before this point.
       NMakeOutput remains project-specific (APK vs AAR). -->
  <PropertyGroup Condition="'$(ConfigurationType)' == 'Makefile'">
    <NMakeBuildCommandLine Condition="'$(NMakeBuildCommandLine)' == ''">cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" $(GradleTask) $(GradleProperties) --no-daemon</NMakeBuildCommandLine>
    <NMakeReBuildCommandLine Condition="'$(NMakeReBuildCommandLine)' == ''">cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" clean $(GradleTask) $(GradleProperties) --no-daemon</NMakeReBuildCommandLine>
    <NMakeCleanCommandLine Condition="'$(NMakeCleanCommandLine)' == ''">cd /d "$(GradleProjectDir)" &amp;&amp; set "ANDROID_HOME=$(AndroidSdkPath)" &amp;&amp; set "JAVA_HOME=$(JavaHome)" &amp;&amp; "$(GradleWrapper)" clean $(GradleProperties) --no-daemon</NMakeCleanCommandLine>
  </PropertyGroup>

  <!-- Shared Build / Clean / Rebuild Targets for Makefile-based Android projects.
       These override the NMake targets from Microsoft.Cpp.targets.
       Projects can add pre/post logic via BeforeTargets/AfterTargets hooks.
       Rebuild always passes clean and disables the Gradle build cache for a true from-scratch build. -->
  <Target Name="Build" Condition="'$(ConfigurationType)' == 'Makefile'">
    <Message Text="========================================" Importance="high" />
    <Message Text="Building $(ProjectName) with Gradle..." Importance="high" />
    <Message Text="  Configuration: $(Configuration)" Importance="normal" />
    <Message Text="  Java Home: $(JavaHome)" Importance="normal" />
    <Message Text="========================================" Importance="high" />

    <Exec Command="&quot;$(GradleWrapper)&quot; $(GradleTask) $(GradleProperties) --no-daemon"
          WorkingDirectory="$(GradleProjectDir)"
          EnvironmentVariables="ANDROID_HOME=$(AndroidSdkPath);JAVA_HOME=$(JavaHome)"
          ConsoleToMsBuild="true"
          Condition="Exists('$(GradleWrapper)')" />

    <Warning Text="Gradle wrapper not found at $(GradleWrapper). Please ensure gradlew.bat exists."
             Condition="!Exists('$(GradleWrapper)')" />
  </Target>

  <Target Name="Clean" Condition="'$(ConfigurationType)' == 'Makefile'">
    <Message Text="Cleaning $(ProjectName) with Gradle..." Importance="high" />
    <Exec Command="&quot;$(GradleWrapper)&quot; clean $(GradleProperties) --no-daemon"
          WorkingDirectory="$(GradleProjectDir)"
          EnvironmentVariables="ANDROID_HOME=$(AndroidSdkPath);JAVA_HOME=$(JavaHome)"
          ConsoleToMsBuild="true"
          IgnoreExitCode="true"
          Condition="Exists('$(GradleWrapper)')" />
  </Target>

  <Target Name="Rebuild" DependsOnTargets="CleanStagedJavaSources;StageJavaSources"
          Condition="'$(ConfigurationType)' == 'Makefile'">
    <Message Text="========================================" Importance="high" />
    <Message Text="Rebuilding $(ProjectName) with Gradle (no build cache)..." Importance="high" />
    <Message Text="========================================" Importance="high" />

    <Exec Command="&quot;$(GradleWrapper)&quot; clean $(GradleTask) $(GradleProperties) --no-daemon --no-build-cache"
          WorkingDirectory="$(GradleProjectDir)"
          EnvironmentVariables="ANDROID_HOME=$(AndroidSdkPath);JAVA_HOME=$(JavaHome)"
          ConsoleToMsBuild="true"
          Condition="Exists('$(GradleWrapper)')" />
  </Target>

</Project>
